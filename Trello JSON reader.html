<!doctype html>

<html>
   <head>
      <meta http-equiv="content-type" content="text/html; charset=UTF-8">
      <title>
         Trello JSON Reader
      </title>
      <style type="text/css">
         #btnRead
         {
            border: 1px solid black;
            border-radius: 5px;
            padding: 1px 5px;
            cursor: pointer;
         }

         #btnRead:link, #btnRead:visited
         {
         }
         
         #btnRead:hover
         {
            border-color: blue;
            color: blue;
         }
         
         #btnRead:active
         {
            margin: 2px 0px 0px 1px;
         }
         
         #parse_strings
         {
            width: 100px;
         }
         
         .name
         {
            display: inline-block;
            width: 10em;
            height: 20px;
            overflow: hidden;
         }
      </style>
      <script type="text/javascript">
         //https://trello.com/b/v8F0swkO.json
         
         var how_to_parse;
         var ToDoSum;
         var DoingSum;
         var DoneSum;
         var Dates;
         var Lists;
         var lastDate;
         var Work;
         
         function processJSON()
         {
            //document.getElementById("JSON_out").innerHTML = "";
            //
            //var xmlHttp = new XMLHttpRequest();
            //xmlHttp.onreadystatechange = function()
            //{
            //   document.getElementById("JSON_out").innerHTML += xmlHttp.readyState.toString() + " - " + xmlHttp.status.toString() + "<br />";
            //   if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            //   {
            //      document.getElementById("JSON_out").innerHTML = xmlHttp.responseText;
            //   }
            //}
            //xmlHttp.open("GET", "https://trello.com/b/v8F0swkO.json", true); // true for asynchronous 
            //xmlHttp.setRequestHeader("Cookie", "mab=57f7d2347989147240b2cc42; _ga=GA1.2.8894175.1477086473; _sp_id.dc4d=92d8f9b8d47e204c.1477086473.6.1477706974.1477703178.785d6ccf-6c30-4e06-9433-aa352af95354; __hstc=183819321.4d7ad47ff27ae4839ade35b9392be05b.1477086474449.1477086474449.1477086474449.1; hsfirstvisit=https%3A%2F%2Ftrello.com%2F|https%3A%2F%2Fsearch.yahoo.com|1477086474448; hubspotutk=4d7ad47ff27ae4839ade35b9392be05b; __leadinutk=4d7ad47ff27ae4839ade35b9392be05b; __leadinmigrated=1; token=57f7d2347989147240b2cc42%2F64t8fCLB5PRsRgHV0pzH12PELjAyYFnVZmVtjufwkTxd33hICyPME2hCmtc8Wde2; hasAccount=password; dsc=852fb5a154360f0d14f3c14bf9c8203c348c121533b82199d8b1960afa268330; lang=en-US; _sp_ses.dc4d=*");
            //xmlHttp.send(null);
            document.getElementById("controls").style.display = "block";

            var JSON_text = document.getElementById("JSON_in").value;
            
            if(JSON_text.length > 0)
            {
               document.getElementById("JSON_out").innerHTML = "";
               document.getElementById("JSON_status").innerHTML = "";
               var obj = JSON.parse(JSON_text);
               var regExp;
               ToDoSum = 0;
               DoingSum = 0;
               DoneSum = 0;
               var CurrentLists = [];
               var textCurrentLists = "";
               var textDates = "";
               var htmlDates = "";
               var workItems = "";
               var largestWorkItem = 0;
               var first_day = new Date(2016,9,7);
               lastDate = dateToString(first_day);
               var end_of_today = new Date();
               end_of_today.setDate(end_of_today.getDate() + 1); //If adding days, shifts the month or year, the changes are handled automatically by the Date object.
               end_of_today.setHours(0);
               end_of_today.setMinutes(0);
               end_of_today.setSeconds(0);
               end_of_today.setMilliseconds(0);

               //Replace member IDs
               for (var index in obj.members)
               {
                  regExp = new RegExp(obj.members[index].id.toString(), "g");  // regex pattern string without the slashes, ... not /.../  ; added the global modifier to replace all occurances
                  JSON_text = JSON_text.replace(regExp, obj.members[index].fullName);
               }
               //Replace label IDs
               for (var index in obj.labels)
               {
                  regExp = new RegExp(obj.labels[index].id.toString(), "g");  // regex pattern string without the slashes, ... not /.../  ; added the global modifier to replace all occurances
                  JSON_text = JSON_text.replace(regExp, obj.labels[index].name);
               }
               //Replace list IDs and buil an array of the lists
               for (var index in obj.lists)
               {
                  //--------------------------------------------------------
                  CurrentLists.push(obj.lists[index].name);
                  //--------------------------------------------------------
                  regExp = new RegExp(obj.lists[index].id.toString(), "g");  // regex pattern string without the slashes, ... not /.../  ; added the global modifier to replace all occurances
                  JSON_text = JSON_text.replace(regExp, obj.lists[index].name);
               }
               
               //--------------------------------------------------------
               //Make empty Lists and Work objects from the array of list names
               for (var index in CurrentLists)
               {
                  if(textCurrentLists.length > 0)
                  {
                     textCurrentLists += ",";
                  }
                  textCurrentLists += "\""+CurrentLists[index]+"\":0";
               }
               textCurrentLists = "{"+textCurrentLists+"}";//+",\"Completed\":0}";
               Lists = JSON.parse(textCurrentLists);                   //array of accumulators for each list
               Work = JSON.parse(textCurrentLists.replace(/0/g,"[]")); //array of text objects

               //Make empty Date object as an array of days each of which is an object of list names
               for (var day = first_day; day <= end_of_today; day.setDate(day.getDate() + 1))
               {
                  if(textDates.length > 0)
                  {
                     textDates += ",";
                  }
                  textDates += "\""+dateToString(day)+"\":"+textCurrentLists;
               }
               textDates = "{"+textDates+"}";

               Dates = JSON.parse(textDates); //{day:{h:0,k:0, ...},day:{h:0,k:0, ...}, ... }
               //--------------------------------------------------------

               JSON_text = JSON_text.replace(/idList/g, "List");
               JSON_text = JSON_text.replace(/idMembers/g, "Members");
               obj = JSON.parse(JSON_text);

               //flip the chronological order of actions and fill Dates object
               //loop of add up then fill Date
               obj.actions.reverse();
               obj.actions.forEach(sumation2);
               //this is the "fill Date" for the last add
               if(lastDate != dateToString(end_of_today))
               {
                  for (var day = StringTodate(lastDate); day <= end_of_today; day.setDate(day.getDate() + 1))
                  {
                     for (var list in Lists)
                     {
                        Dates[dateToString(day)][list] = Lists[list];
                     }
                  }
               }
               obj.cards.forEach(sumation);
               obj.cards.forEach(sumation3);
               document.getElementById("JSON_out").innerHTML +=   "Total Cards: " + "    ".slice(0,4 - obj.cards.length.toString().length) + obj.cards.length.toString()
                                                            + "\t\tTotal Actions: " + "    ".slice(0,4 - obj.actions.length.toString().length) + obj.actions.length.toString();
               document.getElementById("JSON_out").innerHTML += "\nTo-Do Cards: " + "    ".slice(0,4 - ToDoSum.toString().length) + ToDoSum.toString();
               document.getElementById("JSON_out").innerHTML += "\nDoing Cards: " + "    ".slice(0,4 - DoingSum.toString().length) + DoingSum.toString();
               document.getElementById("JSON_out").innerHTML += "\nDone Cards:  " + "    ".slice(0,4 - DoneSum.toString().length) + DoneSum.toString();
               document.getElementById("JSON_out").innerHTML += "\n";
               
               how_to_parse = document.getElementById("JSON_Parse").value.split(";");
               
               makeJSONtree(obj, "", 0);
               
               //--------------------------------------------------------
               htmlDates += "<tr><td>Date</td>";
               for (var list in Dates["2016-10-07"])
               {
                  htmlDates += "<td>"+list+"</td>";
               }
               htmlDates += "</tr>\n";
               for (var date in Dates)
               {
                  htmlDates += "<tr><td>"+date+"</td>";
                  for (var list in Dates[date])
                  {
                     htmlDates += "<td>"+Dates[date][list]+"</td>";
                  }
                  htmlDates += "</tr>\n";
               }
               document.getElementById("JSON_out2").innerHTML = htmlDates;
               //--------------------------------------------------------
               workItems += "<tr><td></td>";
               for (var list in Work)
               {
                  workItems += "<td>"+list+"</td>";
                  if(Work[list].length > largestWorkItem)
                  {
                     largestWorkItem = Work[list].length;
                  }
               }
               workItems += "</tr>\n";
               for (var num = 0; num < largestWorkItem; num += 1)
               {
                  workItems += "<tr><td>"+(num+1).toString()+"</td>";
                  for (var list in Work)
                  {
                     if(Work[list][num])
                     {
                        workItems += "<td>"+Work[list][num]+"</td>";
                     }
                     else
                     {
                        workItems += "<td></td>";
                     }
                  }
                  workItems += "</tr>\n";
               }
               document.getElementById("JSON_out3").innerHTML = workItems;
               //--------------------------------------------------------

               document.getElementById("JSON_status").innerHTML += " Done";
            }
            else
            {
               document.getElementById("JSON_status").innerHTML += " No JSON!";
            }

         }

         function makeJSONtree(obj, indent, level)
         {
            if(how_to_parse.length > level)
            {
               for (var key in obj)
               {
                  //document.getElementById("JSON_status").innerHTML += key + ": " + how_to_parse[level].includes(key) + "<br />";
                  if(how_to_parse[level].includes(key) || how_to_parse[level].includes("all"))
                  {
                     if(typeof obj[key] == "object")
                     {
                        document.getElementById("JSON_out").innerHTML += "\n" + indent + key + ":"
                        makeJSONtree(obj[key], indent + "\t", level + 1);
                     }
                     else
                     {
                        document.getElementById("JSON_out").innerHTML += "\n" + indent + key + ": " + obj[key];
                     }
                  }
                  else
                  {
                     //delete obj[key];
                  }
               }
            }
            else
            {
               if(!document.getElementById("JSON_status").innerHTML.includes("exceeded"))
               {
                  document.getElementById("JSON_status").innerHTML += "object levels exceeded at " + level.toString() + "/" + how_to_parse.length.toString();
               }
            }
         }
         
         function sumation(item, index) //Count the To-do, Doing, Done
         {
            if(item.List == "To-do List")
            {
               ToDoSum += 1;
            }
            if(item.List == "Doing")
            {
               DoingSum += 1;
            }
            if(item.List == "Done")
            {
               DoneSum += 1;
            }
         }

         function sumation2(item, index) //Count action items for day-to-day working movements for Excel chart
         {
            if(lastDate != item.date.slice(0,10))
            {
               for (var day = StringTodate(lastDate); day <= StringTodate(item.date.slice(0,10)); day.setDate(day.getDate() + 1))
               {
                  for (var list in Lists)
                  {
                     Dates[dateToString(day)][list] = Lists[list];
                  }
               }
            }
            if(item.type == "createCard")
            {
               Lists[item.data.list.id] += 1;
            }
            if(item.type == "deleteCard")
            {
               Lists[item.data.list.id] -= 1;
            }
            if(item.type == "updateCard" )
            {
               try
               {
                  if(item.data.listBefore.toString() != "undefined")
                  {
                     if(item.data.listBefore.id != item.data.listAfter.id)
                     {
                        Lists[item.data.listBefore.id] -= 1;

                        Lists[item.data.listAfter.id] += 1;
                     }
                  }
               }
               catch(ex)
               {}
            }
            lastDate = item.date.slice(0,10);
         }

         function sumation3(item, index) //Show a small description of all the things in each list
         {
            var workers = "";
            for (var member in item.Members)
            {
               if(workers.length > 0)
               {
                  workers += ", ";
               }
               workers += item.Members[member].replace(/[abcdefghijklmnopqrstuvwxyz ]/g, "");
            }
         
            if(item.due != null)
            {
               Work[item.List].push("<span class='name'>"+item.name+"</span><br />Due:"+item.due.slice(0,10)+"<br />"+workers);
            }
            else
            {
               Work[item.List].push("<span class='name'>"+item.name+"</span><br />Due: -<br />"+workers);
            }
         }

         function dateToString(date)
         {
            return date.getFullYear()+"-"+"00".slice(0,2 - (date.getMonth()+1).toString().length)+(date.getMonth()+1)+"-"+"00".slice(0,2 - date.getDate().toString().length)+date.getDate();
         }

         function StringTodate(date)
         {
            return new Date(parseInt(date.slice(0,4)),(parseInt(date.slice(5,7)) - 1),parseInt(date.slice(8,10)));
         }

         function parse_strings_select(text)
         {
            document.getElementById("JSON_Parse").value = text;
         }

         function chkJSON_checked()
         {
            var out = document.getElementById("JSON_out");
            if(out.style.display == "none")
            {
               out.style.display = "block";
            }
            else
            {
               out.style.display = "none";
            }
         }

         function chkitems_checked()
         {
            var out = document.getElementById("JSON_out2");
            if(out.style.display == "none")
            {
               out.style.display = "block";
            }
            else
            {
               out.style.display = "none";
            }
         }

         function chkwork_checked()
         {
            var out = document.getElementById("JSON_out3");
            if(out.style.display == "none")
            {
               out.style.display = "block";
            }
            else
            {
               out.style.display = "none";
            }
         }
         </script>
   </head>
   <body>
      <form>
         JSON:<input type="text" id="JSON_in"/>
         Parse:<input type="text" id="JSON_Parse" value="" />
         <select id="parse_strings" onchange="parse_strings_select(this.value);" >
            <option value="" selected="selected"></option>
            <option value="all;all;all">all;all;all</option>
            <option value="cards;all;name desc List due Members attachments;all;bytes date idMember name">cards;all;name desc List due Members attachments;all;bytes date idMember name</option>
            <option value="actions;all;all;all">actions;all;all;all</option>
            <option value="lists;all;all;all">lists;all;all;all</option>
            <option value="members;all;all;all">members;all;all;all</option>
         </select>
         <span   id="btnRead" onclick="processJSON();">Read</span>
         <span   id="JSON_status"></span>
         <div    id="controls" style="display:none;">
            <label for="chkJSON">Show JSON parsed      </label><input type="checkbox" id="chkJSON"  name="control" checked="checked" onclick="chkJSON_checked();" />&nbsp;&nbsp;&nbsp;
            <label for="chkitems">Show list item chart </label><input type="checkbox" id="chkitems" name="control" checked="checked" onclick="chkitems_checked();" />&nbsp;&nbsp;&nbsp;
            <label for="chkwork">Show current work     </label><input type="checkbox" id="chkwork"  name="control" checked="checked" onclick="chkwork_checked();" />
         </div>
         <pre    id="JSON_out"></pre>
         <table  id="JSON_out2"></table>
         <table  id="JSON_out3"></table>
      </form>
   </body>
</html>